{% extends "base.html" %}

{% block title %}Iris分類システム - 予測履歴{% endblock %}

{% block extra_css %}
<style>
    .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .history-table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    
    .history-table td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .history-table tr:hover {
        background: #f5f5f5;
    }
    
    .prediction-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9em;
    }
    
    .badge-setosa {
        background: #d4edda;
        color: #155724;
    }
    
    .badge-versicolor {
        background: #fff3cd;
        color: #856404;
    }
    
    .badge-virginica {
        background: #f8d7da;
        color: #721c24;
    }
    
    .confidence-indicator {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }
    
    .confidence-high {
        background: #d4edda;
        color: #155724;
    }
    
    .confidence-medium {
        background: #fff3cd;
        color: #856404;
    }
    
    .confidence-low {
        background: #f8d7da;
        color: #721c24;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.2em;
    }
    
    .stats-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #764ba2;
    }
    
    .stat-label {
        color: #666;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<h2>📈 予測履歴</h2>

<div class="stats-container">
    <div class="stat-card">
        <div class="stat-value">{{ predictions|length }}</div>
        <div class="stat-label">総予測数</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">
            {% if predictions %}
                {{ "%.1f"|format(predictions|map(attribute='confidence')|sum / predictions|length * 100) }}%
            {% else %}
                0%
            {% endif %}
        </div>
        <div class="stat-label">平均信頼度</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">
            {% if predictions %}
                {{ predictions[0].prediction_name }}
            {% else %}
                -
            {% endif %}
        </div>
        <div class="stat-label">最新の予測</div>
    </div>
</div>

{% if predictions %}
<table class="history-table">
    <thead>
        <tr>
            <th>日時</th>
            <th>がく片長さ</th>
            <th>がく片幅</th>
            <th>花弁長さ</th>
            <th>花弁幅</th>
            <th>予測結果</th>
            <th>信頼度</th>
        </tr>
    </thead>
    <tbody>
        {% for pred in predictions %}
        <tr>
            <td>{{ pred.created_at.strftime('%Y-%m-%d %H:%M') if pred.created_at else '-' }}</td>
            <td>{{ pred.sepal_length }}</td>
            <td>{{ pred.sepal_width }}</td>
            <td>{{ pred.petal_length }}</td>
            <td>{{ pred.petal_width }}</td>
            <td>
                <span class="prediction-badge badge-{{ pred.prediction_name }}">
                    {{ pred.prediction_name }}
                </span>
            </td>
            <td>
                {% set conf_level = 'high' if pred.confidence > 0.9 else 'medium' if pred.confidence > 0.7 else 'low' %}
                <span class="confidence-indicator confidence-{{ conf_level }}">
                    {{ "%.1f"|format(pred.confidence * 100) }}%
                </span>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div class="no-data">
    <p>まだ予測履歴がありません</p>
    <p>予測を実行すると、ここに履歴が表示されます</p>
</div>
{% endif %}
{% endblock %}